name: 更新机器人数据

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # 每5分钟运行一次

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: 获取飞书数据
        env:
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          APP_TOKEN: ${{ secrets.FEISHU_APP_TOKEN }}
          TABLE_ID: ${{ secrets.FEISHU_TABLE_ID }}
        run: |
          # 获取 access token
          TOKEN=$(curl -s -X POST "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal" \
            -H "Content-Type: application/json" \
            -d "{\"app_id\":\"$FEISHU_APP_ID\",\"app_secret\":\"$FEISHU_APP_SECRET\"}" | \
            jq -r '.tenant_access_token')
          
          # 获取数据
          curl -s -X GET "https://open.feishu.cn/open-apis/bitable/v1/apps/$APP_TOKEN/tables/$TABLE_ID/records?page_size=100" \
            -H "Authorization: Bearer $TOKEN" > data/robots.json
          
          # 显示数据
          cat data/robots.json | jq '.data.items[] | select(.fields.Name != null) | .fields'
      
      - name: 提交数据
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "data: 更新机器人数据"
          file_pattern: data/robots.json
