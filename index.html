<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetHub - æœºç¾¤ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }
        :root { --primary: #4F46E5; --primary-light: #818CF8; --bg-dark: #0D1117; --bg-card: #161B22; --bg-card-hover: #1C2128; --border: #30363D; --text-primary: #E6EDF3; --text-secondary: #8B949E; --success: #3FB950; --warning: #D29922; --danger: #F85149; --offline: #6E7681; --running: #58A6FF; --queued: #9CA3AF; }
        body { background: var(--bg-dark); color: var(--text-primary); }
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 20px 0; position: fixed; height: 100vh; }
        .logo { padding: 0 20px 24px; display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo h1 { font-size: 16px; font-weight: 700; }
        .nav-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; padding: 16px 20px 8px; font-weight: 600; }
        .nav-item { padding: 10px 20px; display: flex; align-items: center; gap: 10px; color: var(--text-secondary); cursor: pointer; transition: 0.2s; font-size: 14px; }
        .nav-item:hover, .nav-item.active { background: rgba(79,70,229,0.1); color: var(--primary-light); }
        .main { margin-left: 220px; flex: 1; padding: 24px 32px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .header h2 { font-size: 24px; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 16px; border: 1px solid var(--border); }
        .stat-card h3 { font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .section-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin: 24px 0 16px; display: flex; justify-content: space-between; align-items: center; }
        
        /* æœºå™¨äººå¡ç‰‡ */
        .robots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
        .robot-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
        .robot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .robot-info { display: flex; align-items: center; gap: 12px; }
        .robot-avatar { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 16px; }
        .robot-name { font-size: 16px; font-weight: 600; }
        .robot-owner { font-size: 12px; color: var(--text-secondary); }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .status-badge.running { background: rgba(88,166,255,0.15); color: var(--running); }
        .status-badge.idle { background: rgba(156,163,175,0.15); color: var(--queued); }
        .status-badge.offline { background: rgba(110,118,129,0.15); color: var(--offline); }
        
        .robot-task { background: var(--bg-dark); border-radius: 8px; padding: 12px; margin: 12px 0; }
        .task-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; }
        .task-name { font-size: 14px; font-weight: 500; color: var(--primary-light); }
        .task-progress { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
        .progress-bar { flex: 1; height: 6px; background: var(--bg-card); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); }
        .progress-text { font-size: 12px; color: var(--text-secondary); }
        
        .robot-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .metric { background: var(--bg-dark); border-radius: 6px; padding: 8px; text-align: center; }
        .metric-label { font-size: 10px; color: var(--text-secondary); }
        .metric-value { font-size: 14px; font-weight: 600; }
        
        .robot-tags { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 3px 8px; background: rgba(79,70,229,0.15); color: var(--primary-light); border-radius: 4px; }
        
        /* ä»»åŠ¡é˜Ÿåˆ— */
        .task-queue { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .task-item { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .task-item:last-child { border-bottom: none; }
        .task-item:hover { background: var(--bg-card-hover); }
        .task-priority { width: 4px; height: 40px; border-radius: 2px; margin-right: 16px; }
        .task-priority.high { background: var(--danger); }
        .task-priority.medium { background: var(--warning); }
        .task-priority.low { background: var(--success); }
        .task-info { flex: 1; }
        .task-title { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
        .task-meta { font-size: 12px; color: var(--text-secondary); display: flex; gap: 16px; }
        .task-source { display: flex; align-items: center; gap: 4px; }
        .task-assignee { display: flex; align-items: center; gap: 8px; }
        .assignee-avatar { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; }
        .assignee-avatar.robot { background: var(--primary); color: white; }
        .assignee-avatar.human { background: var(--success); color: white; }
        .assignee-avatar.unassigned { background: var(--border); color: var(--text-secondary); }
        
        .task-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .task-status.QUEUED { background: rgba(156,163,175,0.15); color: var(--queued); }
        .task-status.RUNNING { background: rgba(88,166,255,0.15); color: var(--running); }
        .task-status.COMPLETED { background: rgba(63,185,80,0.15); color: var(--success); }
        
        .loading { padding: 40px; text-align: center; color: var(--text-secondary); }
        .spinner { width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .view-content { display: none; }
        .view-content.active { display: block; }
        .btn { padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: var(--primary-light); }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo"><div class="logo-icon">ğŸš€</div><h1>FleetHub</h1></div>
            <div class="nav-label">æ¦‚è§ˆ</div>
            <div class="nav-item active" onclick="switchView('dashboard')">ğŸ“Š ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒ</div>
            <div class="nav-label">ç®¡ç†</div>
            <div class="nav-item" onclick="switchView('robots')">ğŸ¤– æœºå™¨äºº</div>
            <div class="nav-item" onclick="switchView('queue')">ğŸ“‹ ä»»åŠ¡é˜Ÿåˆ—</div>
        </aside>
        
        <main class="main">
            <header class="header">
                <h2>ğŸ¤– æœºç¾¤ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒ</h2>
                <button class="btn" onclick="refreshAll()">ğŸ”„ åˆ·æ–°</button>
            </header>
            
            <!-- ç»Ÿè®¡ -->
            <div class="stats-grid">
                <div class="stat-card"><h3>æ€»æœºå™¨äºº</h3><div class="stat-value" id="stat-total">-</div></div>
                <div class="stat-card"><h3>å·¥ä½œä¸­</h3><div class="stat-value" id="stat-running" style="color:var(--running)">-</div></div>
                <div class="stat-card"><h3>ç©ºé—²</h3><div class="stat-value" id="stat-idle" style="color:var(--success)">-</div></div>
                <div class="stat-card"><h3>å¾…æ¥ä»»åŠ¡</h3><div class="stat-value" id="stat-queued">-</div></div>
                <div class="stat-card"><h3>è¿›è¡Œä¸­</h3><div class="stat-value" id="stat-progress">-</div></div>
                <div class="stat-card"><h3>å·²å®Œæˆ</h3><div class="stat-value" id="stat-completed" style="color:var(--success)">-</div></div>
            </div>
            
            <!-- Dashboard è§†å›¾ -->
            <div id="view-dashboard" class="view-content active">
                <div class="section-title">
                    <span>ğŸ¤– æœºå™¨äººçŠ¶æ€ä¸å½“å‰ä»»åŠ¡</span>
                </div>
                <div class="robots-grid" id="robots-grid"><div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div></div>
                
                <div class="section-title">
                    <span>ğŸ“‹ ä»»åŠ¡é˜Ÿåˆ— (å¾…æ¥å–)</span>
                    <span style="font-size:12px;color:var(--text-secondary)">æŒ‰ä¼˜å…ˆçº§æ’åº</span>
                </div>
                <div class="task-queue" id="task-queue"><div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div></div>
            </div>
            
            <!-- æœºå™¨äººè§†å›¾ -->
            <div id="view-robots" class="view-content">
                <div class="robots-grid" id="robots-grid-full"><div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div></div>
            </div>
            
            <!-- é˜Ÿåˆ—è§†å›¾ -->
            <div id="view-queue" class="view-content">
                <div class="task-queue" id="task-queue-full"><div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div></div>
            </div>
        </main>
    </div>
    
    <script>
        const DATA_URL = 'https://raw.githubusercontent.com/guyuan9300-max/fleethub/main/';
        
        async function loadJSON(file) {
            try {
                const res = await fetch(DATA_URL + file + '?t=' + Date.now());
                if (res.ok) return await res.json();
            } catch(e) { console.error(file, e); }
            return null;
        }
        
        async function refreshAll() {
            const [robots, tasks] = await Promise.all([
                loadJSON('robots.json'),
                loadJSON('tasks.json')
            ]);
            renderStats(robots, tasks);
            renderRobots(robots);
            renderTaskQueue(tasks);
        }
        
        function renderStats(robots, tasks) {
            const running = (robots||[]).filter(r => r.status === 'running').length;
            const idle = (robots||[]).filter(r => r.status === 'idle').length;
            const queued = (tasks||[]).filter(t => t.status === 'QUEUED').length;
            const inProgress = (tasks||[]).filter(t => t.status === 'RUNNING').length;
            const completed = (tasks||[]).filter(t => t.status === 'COMPLETED').length;
            
            document.getElementById('stat-total').textContent = (robots||[]).length || 0;
            document.getElementById('stat-running').textContent = running;
            document.getElementById('stat-idle').textContent = idle;
            document.getElementById('stat-queued').textContent = queued;
            document.getElementById('stat-progress').textContent = inProgress;
            document.getElementById('stat-completed').textContent = completed;
        }
        
        function renderRobots(robots) {
            if (!robots || robots.length === 0) {
                const msg = '<div class="loading">æš‚æ— æœºå™¨äºº</div>';
                document.getElementById('robots-grid').innerHTML = msg;
                document.getElementById('robots-grid-full').innerHTML = msg;
                return;
            }
            
            const colors = {'é¡¾æºæºçš„ MacBook Air': '#4F46E5', 'é»˜é»˜æœºå™¨äºº': '#10B981'};
            const html = robots.map(r => {
                const color = colors[r.name] || '#6E7681';
                const statusText = r.status === 'running' ? 'å·¥ä½œä¸­' : r.status === 'idle' ? 'ç©ºé—²' : 'ç¦»çº¿';
                return `
                <div class="robot-card">
                    <div class="robot-header">
                        <div class="robot-info">
                            <div class="robot-avatar" style="background:${color}">${r.name[0]}</div>
                            <div>
                                <div class="robot-name">${r.name}</div>
                                <div class="robot-owner">${r.owner} Â· ${r.location}</div>
                            </div>
                        </div>
                        <span class="status-badge ${r.status}">${statusText}</span>
                    </div>
                    
                    ${r.current_task ? `
                    <div class="robot-task">
                        <div class="task-label">å½“å‰ä»»åŠ¡</div>
                        <div class="task-name">${r.current_task}</div>
                        <div class="task-progress">
                            <div class="progress-bar"><div class="progress-fill" style="width:${r.progress}%"></div></div>
                            <span class="progress-text">${r.progress}%</span>
                        </div>
                    </div>` : `
                    <div class="robot-task">
                        <div class="task-label">å½“å‰ä»»åŠ¡</div>
                        <div class="task-name" style="color:var(--text-secondary)">ç­‰å¾…ä»»åŠ¡ä¸­...</div>
                    </div>`}
                    
                    <div class="robot-metrics">
                        <div class="metric"><div class="metric-label">CPU</div><div class="metric-value">${r.cpu}%</div></div>
                        <div class="metric"><div class="metric-label">å†…å­˜</div><div class="metric-value">${r.memory}%</div></div>
                        <div class="metric"><div class="metric-label">å¥åº·åº¦</div><div class="metric-value" style="color:${r.health_score > 70 ? 'var(--success)' : 'var(--warning)'}">${r.health_score}%</div></div>
                    </div>
                    
                    <div class="robot-tags">
                        ${(r.capabilities||[]).map(c => `<span class="tag">${c}</span>`).join('')}
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('robots-grid').innerHTML = html;
            document.getElementById('robots-grid-full').innerHTML = html;
        }
        
        function renderTaskQueue(tasks) {
            if (!tasks || tasks.length === 0) {
                const msg = '<div class="loading">æš‚æ— ä»»åŠ¡</div>';
                document.getElementById('task-queue').innerHTML = msg;
                document.getElementById('task-queue-full').innerHTML = msg;
                return;
            }
            
            // æŒ‰çŠ¶æ€å’Œä¼˜å…ˆçº§æ’åº
            const sorted = [...tasks].sort((a, b) => {
                const statusOrder = { 'RUNNING': 0, 'QUEUED': 1, 'COMPLETED': 2 };
                if (statusOrder[a.status] !== statusOrder[b.status]) return statusOrder[a.status] - statusOrder[b.status];
                const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            const sourceIcons = { 'feishu_group': 'ğŸ’¬', 'feishu_dm': 'ğŸ“±', 'manual': 'âœï¸', 'scheduler': 'â°' };
            
            const html = sorted.map(t => {
                const assigneeAvatar = t.assigned_to ? 
                    `<div class="assignee-avatar robot">${t.assigned_to[0]}</div>` :
                    `<div class="assignee-avatar unassigned">?</div>`;
                
                return `
                <div class="task-item">
                    <div class="task-priority ${t.priority}"></div>
                    <div class="task-info">
                        <div class="task-title">${t.title}</div>
                        <div class="task-meta">
                            <span class="task-source">${sourceIcons[t.source_type] || 'ğŸ“‹'} ${t.source}</span>
                            <span>ğŸ‘¤ ${t.requester}</span>
                            <span>â±ï¸ é¢„è®¡${t.estimated_minutes}åˆ†é’Ÿ</span>
                        </div>
                    </div>
                    <div class="task-assignee">
                        ${assigneeAvatar}
                        <span style="font-size:12px;color:var(--text-secondary)">${t.assigned_to || 'å¾…åˆ†é…'}</span>
                    </div>
                    <span class="task-status ${t.status}">${t.status === 'QUEUED' ? 'å¾…æ¥' : t.status === 'RUNNING' ? 'è¿›è¡Œä¸­' : 'å·²å®Œæˆ'}</span>
                </div>`;
            }).join('');
            
            document.getElementById('task-queue').innerHTML = html;
            document.getElementById('task-queue-full').innerHTML = html;
        }
        
        function switchView(view) {
            document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            event.target.classList.add('active');
        }
        
        refreshAll();
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
